<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Rider Account & Test Data</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
            background: #f4f4f4;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            color: #333;
        }

        input {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        button:hover {
            background: #218838;
        }

        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <script>
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `
                <div style="background:#ffebee; color:#c62828; padding:2rem; text-align:center; border:2px solid #ef9a9a; border-radius:8px;">
                    <h2>âš ï¸ Stop! You opened this file incorrectly.</h2>
                    <p style="font-size:1.2rem;">You are using <code>file://</code> protocol. This prevents the app from connecting to Firebase.</p>
                    <p>Please open this link instead:<br>
                    <a href="http://localhost:3000/setup-rider.html" style="font-size:1.5rem; font-weight:bold; color:#d32f2f;">http://localhost:3000/setup-rider.html</a>
                    </p>
                    <p>(Or check your URL bar and replace <code>file:///C:/...</code> with <code>http://localhost:3000/...</code>)</p>
                </div>
            `;
            throw new Error("Wrong protocol");
        }
    </script>
    <div class="card">
        <h1>ðŸš€ Create Test Rider Account</h1>
        <p>This tool will create a Firebase Authentication user for a rider and assign a dummy "In Transit" delivery to
            them so you can test the tracking immediately.</p>

        <input type="email" id="email" placeholder="Email (e.g. rider@lemaison.ph)" value="rider@test.com">
        <input type="password" id="password" placeholder="Password (min 6 chars)" value="rider123">
        <input type="text" id="name" placeholder="Rider Name" value="Test Rider">

        <button id="createBtn">Create Account & Test Delivery</button>

        <div id="status"></div>
    </div>

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { firebaseConfig } from "./assets/js/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const createBtn = document.getElementById('createBtn');
        const statusEl = document.getElementById('status');

        createBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;

            createBtn.disabled = true;
            createBtn.textContent = 'Processing...';
            statusEl.style.display = 'none';

            try {
                // 1. Create User
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. Update Profile Name
                await updateProfile(user, { displayName: name });

                // 3. Create Dummy Order
                const orderRef = await addDoc(collection(db, 'orders'), {
                    customerName: "Test Customer",
                    totalAmount: 1250,
                    status: "out for delivery", // match delivery status
                    items: [{ name: "Test Burger", quantity: 2, price: 250 }],
                    createdAt: serverTimestamp()
                });

                // 4. Create Dummy "In Transit" Delivery
                await addDoc(collection(db, 'deliveries'), {
                    riderId: user.uid,
                    riderName: name,
                    orderId: orderRef.id,
                    customerName: "Test Customer",
                    address: "Pagsanjan, Laguna", // General area for map center
                    status: "In Transit",
                    currentLocation: { lat: 14.2831, lng: 121.4533 }, // Start at Pagsanjan
                    eta: "15 mins",
                    updatedAt: serverTimestamp()
                });

                statusEl.className = 'success';
                statusEl.textContent = `âœ… Success! Account Created.\nEmail: ${email}\nPassword: ${password}\n\nA test delivery has been assigned. Log in to rider-portal.php now!`;
                statusEl.style.display = 'block';

            } catch (error) {
                console.error(error);
                statusEl.className = 'error';
                statusEl.textContent = `âŒ Error: ${error.message}`;
                statusEl.style.display = 'block';
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Account & Test Delivery';
            }
        });
</body>

</html>

